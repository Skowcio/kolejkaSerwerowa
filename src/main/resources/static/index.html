<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Queue Management</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script>
    var stompClient = null;

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            stompClient.subscribe('/topic/queue', function (eventbody) {
                showQueue(JSON.parse(eventbody.body));
            });
            stompClient.subscribe('/topic/break', function (eventbody) {
                showBreak(JSON.parse(eventbody.body));
            });
        });
    }

    function addToQueue() {
        var name = document.getElementById("nameInput").value;
        fetch('/queue/add?name=' + name);
        document.getElementById("nameInput").value = "";
    }

    function addAsSpecial() {
        var name = document.getElementById("nameInput").value;
        fetch('/queue/add-special?name=' + name);
        document.getElementById("nameInput").value = "";
    }

    function removeFromQueue() {
        var name = document.getElementById("nameInput").value;
        fetch('/queue/remove?name=' + name);
        document.getElementById("nameInput").value = "";
    }

    function removeFirst() {
        fetch('/queue/removeFirst');
    }

    function addToBreak() {
        var name = document.getElementById("nameInput").value;
        fetch('/queue/break/add?name=' + name);
        document.getElementById("nameInput").value = "";
    }

    function removeFromBreak() {
        var name = document.getElementById("nameInput").value;
        fetch('/queue/break/remove?name=' + name)
            .then(response => response.text())
            .then(data => alert(data));
        document.getElementById("nameInput").value = "";
    }

    function showQueue(queue) {
        if (!Array.isArray(queue) || queue.length === 0) return;
        console.log("Show Queue:", queue);
        var queueList = document.getElementById("queueList");
        queueList.innerHTML = "";
        queue.forEach(function (item) {
            var li = document.createElement("li");
            li.appendChild(document.createTextNode(item.name));
            queueList.appendChild(li);
        });
    }

    function showBreak(breakQueue) {
        if (!Array.isArray(breakQueue) || breakQueue.length === 0) return;
        console.log("Show Break:", breakQueue);
        var breakList = document.getElementById("breakList");
        breakList.innerHTML = "";
        breakQueue.forEach(function (item) {
            var li = document.createElement("li");
            li.textContent = item.name + " ";

            var button = document.createElement("button");
            button.textContent = "KOPNIJ";
            button.onclick = function () {
                fetch('/queue/break/remove?name=' + item.name);
            };

            li.appendChild(button);
            breakList.appendChild(li);
        });
    }

    // âœ… Odpala WebSocket i pobiera dane na start
    window.onload = function () {
        connect();

        // lekkie opÃ³Åºnienie (Å¼eby WebSocket siÄ™ poÅ‚Ä…czyÅ‚ zanim wyczyÅ›cimy)
        setTimeout(() => {
            fetch('/queue')
                .then(response => response.json())
                .then(data => showQueue(data));

            fetch('/queue/break')
                .then(response => response.json())
                .then(data => showBreak(data));
        }, 500);
    };

    // ðŸ”„ OdÅ›wieÅ¼anie co 3 sekundy, z logowaniem
    setInterval(function () {
        fetch('/queue')
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) showQueue(data);
                else console.log("OminiÄ™to czyszczenie kolejki â€“ brak danych");
            });

        fetch('/queue/break')
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) showBreak(data);
                else console.log("OminiÄ™to czyszczenie przerwy â€“ brak danych");
            });
    }, 3000);
  </script>
</head>
<body>
<h1>Queue Management</h1>
<input type="text" id="nameInput" placeholder="Enter name">
<button onclick="addToQueue()">dodaj do kolejki</button>
<button onclick="removeFromQueue()">wypisuje z kolejki</button>
<button onclick="removeFirst()">usuwa pierwszego</button>
<button onclick="addAsSpecial()">SPECJAL (dodaj pierwszego)</button>
<br><br>
<button onclick="addToBreak()">Dodaj do przerwy</button>
<button onclick="removeFromBreak()">Zdejmij z przerwy</button>

<h2>Kolejka:</h2>
<ul id="queueList"></ul>

<h2>Przerwa:</h2>
<ul id="breakList"></ul>
</body>
</html>
